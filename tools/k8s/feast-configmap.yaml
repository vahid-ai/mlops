apiVersion: v1
kind: ConfigMap
metadata:
  name: feast-config
  namespace: kubeflow
data:
  feature_store.yaml: |
    project: dfp
    provider: local

    registry:
      # NOTE: /feast is mounted from a ConfigMap (read-only), so the registry
      # must live somewhere writable.
      #
      # For KFP training, also include a pre-built registry in this ConfigMap
      # (binaryData key: registry.db) or create/update it via
      # `tools/scripts/run_kronodroid_pipeline.py --use-kfp-client`.
      path: /tmp/feast/registry.db
      cache_ttl_seconds: 60

    offline_store:
      type: spark
      spark_conf:
        # Iceberg extensions
        spark.sql.extensions: org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
        # LakeFS Iceberg catalog
        spark.sql.catalog.lakefs: org.apache.iceberg.spark.SparkCatalog
        spark.sql.catalog.lakefs.type: hadoop
        spark.sql.catalog.lakefs.warehouse: s3a://kronodroid/main/iceberg
        # S3A filesystem for LakeFS
        spark.hadoop.fs.s3a.impl: org.apache.hadoop.fs.s3a.S3AFileSystem
        spark.hadoop.fs.s3a.aws.credentials.provider: org.apache.hadoop.fs.s3a.SimpleAWSCredentialsProvider
        spark.hadoop.fs.s3a.path.style.access: "true"
        spark.hadoop.fs.s3a.connection.ssl.enabled: "false"
        # S3A credentials from env vars (set by K8s secrets)
        spark.hadoop.fs.s3a.access.key: "${LAKEFS_ACCESS_KEY_ID}"
        spark.hadoop.fs.s3a.secret.key: "${LAKEFS_SECRET_ACCESS_KEY}"
        # LakeFS endpoint
        spark.hadoop.fs.s3a.bucket.kronodroid.endpoint: http://lakefs.dfp.svc.cluster.local:8000
        spark.hadoop.fs.s3a.endpoint: http://lakefs.dfp.svc.cluster.local:8000
        # Maven packages
        spark.jars.packages: org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.4.3,org.apache.hadoop:hadoop-aws:3.3.4,com.amazonaws:aws-java-sdk-bundle:1.12.262

    online_store:
      type: redis
      connection_string: redis://redis:6379

    entity_key_serialization_version: 3

    flags:
      alpha_features: true
      on_demand_transforms: true
