{{
    config(
        materialized='table',
        tags=['mart', 'kronodroid']
    )
}}

{#
    Dimension table for malware families with statistics.

    Aggregates sample counts by data source and provides
    temporal statistics for each malware family.
#}

with samples as (
    select * from {{ ref('stg_kronodroid__combined') }}
),

family_stats as (
    select
        data_source,

        -- Counts by data source
        count(*) as total_samples,

        -- Get first row's ingestion timestamp per source
        min(_ingestion_timestamp) as first_ingestion,
        max(_ingestion_timestamp) as last_ingestion

    from samples
    group by data_source
)

select
    data_source as family_id,
    data_source as family_name,
    true as is_data_source,
    total_samples,
    total_samples as unique_samples,
    case when data_source = 'emulator' then total_samples else 0 end as emulator_count,
    case when data_source = 'real_device' then total_samples else 0 end as real_device_count,
    extract(year from first_ingestion) as earliest_year,
    extract(year from last_ingestion) as latest_year,
    1 as year_span,
    current_timestamp as _dbt_loaded_at
from family_stats
order by total_samples desc
