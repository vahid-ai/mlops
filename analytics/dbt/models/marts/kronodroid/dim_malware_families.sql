{{
    config(
        materialized='table',
        tags=['mart', 'kronodroid'],
        file_format='iceberg'
    )
}}

{#
    Dimension table with dataset statistics by source and label.

    Aggregates sample counts for monitoring and analysis.
    
    Note: Uses Spark SQL syntax (no DuckDB-specific features).
#}

with samples as (
    select * from {{ ref('stg_kronodroid__combined') }}
),

stats as (
    select
        data_source,
        is_malware,
        count(*) as sample_count,
        count(distinct app_package) as unique_apps

    from samples
    group by data_source, is_malware
)

select
    concat(data_source, '_', case when is_malware = 1 then 'malware' else 'benign' end) as category_id,
    data_source,
    case when is_malware = 1 then 'malware' else 'benign' end as label_name,
    is_malware,
    sample_count,
    unique_apps,
    current_timestamp() as _dbt_loaded_at
from stats
order by data_source, is_malware desc
