{{
    config(
        materialized='table',
        tags=['mart', 'kronodroid', 'feast'],
        file_format='iceberg'
    )
}}

{#
    Fact table for malware samples with computed features.

    This table is optimized for Feast feature store ingestion.
    It includes all original features plus computed aggregates.
    
    Note: Uses Spark SQL syntax (no DuckDB-specific features).
#}

with staged as (
    select * from {{ ref('stg_kronodroid__combined') }}
)

select
    -- Primary key
    sample_id,

    -- App identifier
    app_package,

    -- Target label
    is_malware,

    -- Data source
    data_source,

    -- Event timestamp for Feast (required for feature views)
    _dbt_loaded_at as event_timestamp

from staged
