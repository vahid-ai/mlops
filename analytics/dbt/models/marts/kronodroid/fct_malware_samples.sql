{{
    config(
        materialized='table',
        tags=['mart', 'kronodroid', 'feast']
    )
}}

{#
    Fact table for malware samples with computed features.

    This table is optimized for Feast feature store ingestion.
    It includes all original features plus computed aggregates.
#}

with staged as (
    select * from {{ ref('stg_kronodroid__combined') }}
)

select
    -- Use sample_id as primary key
    cast(sample_id as varchar) as sample_id,

    -- Include all original columns
    * exclude (sample_id),

    -- Event timestamp for Feast (use ingestion time or current time)
    coalesce(_ingestion_timestamp, current_timestamp) as event_timestamp,

    -- Feature freshness tracking
    _dbt_loaded_at as feature_timestamp

from staged
