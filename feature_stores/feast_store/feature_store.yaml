project: dfp
provider: local

# Registry for feature definitions
registry:
  path: data/registry.db
  cache_ttl_seconds: 60

# Offline store using Spark with LakeFS Iceberg catalog
# Tables located at: s3a://kronodroid/main/kronodroid/<table_name>
offline_store:
  type: spark
  spark_conf:
    # Iceberg extensions
    spark.sql.extensions: org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
    # LakeFS Iceberg catalog (Hadoop-based)
    spark.sql.catalog.lakefs: org.apache.iceberg.spark.SparkCatalog
    spark.sql.catalog.lakefs.type: hadoop
    spark.sql.catalog.lakefs.warehouse: s3a://kronodroid/main
    # Use S3FileIO for proper S3 path handling
    spark.sql.catalog.lakefs.io-impl: org.apache.iceberg.aws.s3.S3FileIO
    spark.sql.catalog.lakefs.s3.endpoint: ${LAKEFS_ENDPOINT_URL}
    spark.sql.catalog.lakefs.s3.path-style-access: "true"
    # S3A filesystem for LakeFS S3 gateway
    spark.hadoop.fs.s3a.impl: org.apache.hadoop.fs.s3a.S3AFileSystem
    spark.hadoop.fs.s3a.path.style.access: "true"
    spark.hadoop.fs.s3a.connection.ssl.enabled: "false"
    # Per-bucket config for LakeFS repository (all branches accessed via same endpoint)
    spark.hadoop.fs.s3a.bucket.kronodroid.endpoint: ${LAKEFS_ENDPOINT_URL}
    spark.hadoop.fs.s3a.bucket.kronodroid.access.key: ${LAKEFS_ACCESS_KEY_ID}
    spark.hadoop.fs.s3a.bucket.kronodroid.secret.key: ${LAKEFS_SECRET_ACCESS_KEY}
    # Default S3A endpoint for LakeFS (fallback for absolute paths in Iceberg metadata)
    spark.hadoop.fs.s3a.endpoint: ${LAKEFS_ENDPOINT_URL}
    spark.hadoop.fs.s3a.access.key: ${LAKEFS_ACCESS_KEY_ID}
    spark.hadoop.fs.s3a.secret.key: ${LAKEFS_SECRET_ACCESS_KEY}
    # Maven packages for Iceberg + S3A (Spark 4.0 compatible)
    spark.jars.packages: org.apache.iceberg:iceberg-spark-runtime-4.0_2.13:1.10.1,org.apache.iceberg:iceberg-aws:1.10.1,org.apache.hadoop:hadoop-aws:3.4.1,software.amazon.awssdk:bundle:2.29.51

# Online store using Redis for low-latency serving
# Set REDIS_CONNECTION_STRING environment variable (format: redis://localhost:6379)
online_store:
  type: redis
  connection_string: ${REDIS_CONNECTION_STRING}

# Entity key serialization (v3 recommended)
entity_key_serialization_version: 3

# Feature server configuration
feature_server:
  enabled: true
  type: local

# Flags
flags:
  alpha_features: true
  on_demand_transforms: true
